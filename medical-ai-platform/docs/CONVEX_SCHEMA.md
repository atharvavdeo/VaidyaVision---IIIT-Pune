# Convex Database Schema

**Version:** 3.0.0 (Frozen â€“ RAG + Visual Chat Ready)  
**Status:** Canonical Source of Truth  

This document defines the authoritative data model for VaidyaVision.
All Convex code (`convex/schema.ts`, queries, mutations) MUST conform to this file.

---

## 1. Identity & Access (`users`)

Central identity table linked to Clerk Auth.

| Field | Type | Description |
|---|---|---|
| `clerkId` | String | Unique ID from Clerk. Indexed. |
| `email` | String | User's email address. |
| `fullName` | String | Display name. |
| `roles` | `Array<"doctor" \| "patient" \| "admin" \| "researcher">` | **CHANGED v3.0**: Array because a user can hold multiple roles (e.g. Doctor + Researcher). |
| `createdAt` | Number | Timestamp (Date.now()). |
| `lastLogin` | Number | Timestamp. |

---

## 2. Doctor Network (`doctors`)

Professional profiles for users with the "doctor" role.

| Field | Type | Description |
|---|---|---|
| `userId` | Id<"users"> | Link to the Identity table. |
| `specialization` | String | e.g., "Radiologist", "Oncologist". |
| `licenseNumber` | String | Medical license ID. |
| `hospitalAffiliation` | String | Current workplace. |
| `isVerified` | Boolean | Manual admin verification flag. |

---

## 3. Medical Imaging (`scans`)

The core entity representing one diagnostic event/upload.

| Field | Type | Description |
|---|---|---|
| `patientId` | Id<"users"> | Owner of the scan (Patient). |
| `doctorId` | Id<"users"> (Optional) | Assigned reviewing doctor. |
| `imageUrl` | String | Storage ID or URL of the raw image. |
| `modality` | String | "X-RAY", "MRI", "CT", "DERMOSCOPY", "FUNDUS", "PATHOLOGY". |
| `anatomy` | String | "CHEST", "BRAIN", "SKIN", "RETINA". |
| `status` | String | "PROCESSING", "COMPLETED", "REVIEWED", "FAILED". |
| `aiResult` | Object (JSON) | **NEW v3.0**: Pure model outputs. (See Section 4). |
| `ragResult` | Object (JSON) | **NEW v3.0**: RAG retrieval data. (See Section 4). |
| `uploadedAt` | Number | Timestamp. |

---

## 4. AI Results vs RAG Results (Conceptual)

In v3.0, we strictly separate the **generation** (Prediction) from the **retrieval** (RAG).

### `aiResult` Structure
The direct output of the Expert Model.
```json
{
  "primaryDiagnosis": "Pneumonia",
  "confidence": 0.94,
  "heatmapUrl": "https://storage...", // GradCAM overlay
  "findings": ["Opacities in lower left lobe", "No pleural effusion"]
}
```

### `ragResult` Structure
The output of the Similarity Search (historical context).
```json
{
  "similarCases": [
    {
       "caseId": "hist_123",
       "similarityScore": 0.89,
       "diagnosis": "Bacterial Pneumonia",
       "outcome": "Responded to antibiotics"
    }
  ]
}
```

---

## 5. Historical Cases (`historicalCases`)

**RAG Memory.** This table stores the "textbook" or anonymized past cases that the AI searches against.

| Field | Type | Description |
|---|---|---|
| `caseId` | String | External ID (e.g., from NIH dataset). |
| `modality` | String | Image type. |
| `anatomy` | String | Body part. |
| `diagnosis` | String | Ground truth diagnosis. |
| `embedding` | Array<Float32> | Vector embedding of the image feature. |
| `metadata` | Object | Clinical notes, patient demographics (anonymized). |
| `imageUrl` | String | Reference image URL. |

---

## 6. Conversations (`conversations`)

One conversation per scan context. Allows the doctor to "chat with the scan".

| Field | Type | Description |
|---|---|---|
| `scanId` | Id<"scans"> | The context of this chat. |
| `participants` | Array<Id<"users">> | Usually [DoctorID]. Could be [Doctor, Patient] later. |
| `startedAt` | Number | Timestamp. |
| `lastMessageAt` | Number | For sorting inbox. |

---

## 7. Messages (`messages`)

Individual messages within a conversation, supporting **Visual Chat**.

| Field | Type | Description |
|---|---|---|
| `conversationId` | Id<"conversations"> | Parent thread. |
| `senderId` | Id<"users"> or "AI" | Who sent it. |
| `text` | String | The actual message content. |
| `visualReference` | Object (Optional) | **NEW v3.0**: Pointing to specific part of image. |
| `visualReference.x` | Number | X-coordinate (0-100%). |
| `visualReference.y` | Number | Y-coordinate (0-100%). |
| `visualReference.label` | String | "This opacity here" or anatomy tag. |
| `sentAt` | Number | Timestamp. |

---

## 8. Clinical Reports (`reports`)

The final output document generated by the doctor (often assisted by AI).

| Field | Type | Description |
|---|---|---|
| `scanId` | Id<"scans"> | Associated scan. |
| `doctorId` | Id<"users"> | Author. |
| `findings` | String | Markdown text of findings. |
| `impression` | String | Final conclusion/diagnosis. |
| `recommendations` | String | Follow-up actions. |
| `isFinalized` | Boolean | True = signed off. Cannot be edited. |
| `generatedAt` | Number | Timestamp. |

---

## 9. Assessments (`assessments`)

Video proctoring and assessment logs (e.g., for Parkinson's or psychological evaluations).

| Field | Type | Description |
|---|---|---|
| `patientId` | Id<"users"> | The patient being assessed. |
| `type` | String | "PARKINSONS_TAP", "SPEECH_ANALYSIS". |
| `videoUrl` | String | Recording of the session. |
| `metrics` | Object | Extracted features (tremor freq, blink rate). |
| `score` | Number | Computed severity score. |
| `conductedAt` | Number | Timestamp. |

---

## 10. Notifications (`notifications`)

System-wide alerts.

| Field | Type | Description |
|---|---|---|
| `recipientId` | Id<"users"> | Target user. |
| `type` | String | "SCAN_READY", "REPORT_SIGNED", "MESSAGE_RECEIVED". |
| `message` | String | Notification body. |
| `link` | String | URL to redirect to (e.g., `/dashboard/doctor/review/123`). |
| `isRead` | Boolean | Read status. |
| `createdAt` | Number | Timestamp. |
